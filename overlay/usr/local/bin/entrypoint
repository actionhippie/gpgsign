#!/usr/bin/env bash
set -eo pipefail

# echo "${INPUT_PRIVATE_KEY}" | gpg --batch --import -
pushd "${GITHUB_WORKSPACE}" >/dev/null
    ARGS=(
        --batch
        --yes
    )

    if [[ -n "${INPUT_PASSPHRASE}" ]]; then
        ARGS+=(--pinentry-mode loopback --passphrase-fd 0)
    fi

    if [[ -n "${INPUT_ARMOR}" -a "${INPUT_ARMOR}" == "true" ]]; then
        ARGS+=(--armor)
    fi

    if [[ -n "${INPUT_DETACH_SIGN}" -a "${INPUT_DETACH_SIGN}" == "true" ]]; then
        ARGS+=(--detach-sign)
    elif [[ -n "${INPUT_CLEAR_SIGN}" -a "${INPUT_CLEAR_SIGN}" == "true" ]]; then
        ARGS+=(--clear-sign)
    else
        ARGS+=(--sign)
    fi

    INCLUDES=()
    for INCLUDE in ${INPUT_FILES}; do
        INCLUDES+=(-path "${GITHUB_WORKSPACE}/${INCLUDE}")
    done

    EXCLUDES=()
    for EXCLUDE in ${INPUT_EXCLUDES}; do
        EXCLUDES+=(! -path "${GITHUB_WORKSPACE}/${EXCLUDE}")
    done

    for FILE in $(find ${GITHUB_WORKSPACE} "${INCLUDES[@]}" "${EXCLUDES[@]}"); do
        echo gpg "${ARGS[@]}"
    done
popd >/dev/null
